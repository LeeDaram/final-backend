<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
		<mapper namespace="CommonSql">
	<!-- 페이지네이션 처리 -->
    <sql id="paginationWhere">
        <![CDATA[WHERE row_num >= #{pageable.offset} + 1 AND row_num <= #{pageable.offset} + #{pageable.pageSize}]]>
    </sql>
    
    <!-- 업소 목록 페이지(추천/평점순) -->
    <sql id="filterPaginationSql">
		SELECT 
			tb.*,
			<if test="data.sort == 0">
				ROW_NUMBER() OVER (ORDER BY like_count DESC, store_name) AS row_num
			</if>
			<if test="data.sort == 1">
				ROW_NUMBER() OVER (ORDER BY review_avg DESC, store_name) AS row_num
			</if>
		FROM (
			SELECT
				gpb.store_id,
				gpb.user_id,
				gpb.INDUSTRY_ID,
				gpb.CONTACT,
				gpb.STORE_IMAGE,
				gpb.TAKEOUT,
				gpb.DELIVERY,
				gpb.WIFI,
				gpb.PET,
				gpb.KID,
				gpb.PARKING,
				bu.STORE_NAME,
				bu.ADDRESS,
				bu.LAT,
				bu.LNG,
				i.INDUSTRY_NAME,
				sgg.SIGUNGU_NAME,
				sgg.SIGUNGU_ID ,
				sd.SIDO_NAME,
				am.price,
				am.main_menu,
				(SELECT NVL(SUM(LIKE_COUNT), 0) FROM review WHERE store_id = gpb.store_id ) AS like_count,
				(SELECT count(*) FROM REVIEW r WHERE r.STORE_ID = GPB.STORE_ID ) AS review_count,
			    (SELECT AVG(rating) FROM REVIEW r  WHERE r.STORE_ID = GPB.STORE_ID ) AS review_avg,
				(SELECT COUNT(*) FROM review r WHERE r.STORE_ID = gpb.STORE_ID AND r.RATING = 5) AS rating_5_count,
			    (SELECT COUNT(*) FROM review r WHERE r.STORE_ID = gpb.STORE_ID AND r.RATING = 4) AS rating_4_count,
			    (SELECT COUNT(*) FROM review r WHERE r.STORE_ID = gpb.STORE_ID AND r.RATING = 3) AS rating_3_count,
			    (SELECT COUNT(*) FROM review r WHERE r.STORE_ID = gpb.STORE_ID AND r.RATING = 2) AS rating_2_count,
			    (SELECT COUNT(*) FROM review r WHERE r.STORE_ID = gpb.STORE_ID AND r.RATING = 1) AS rating_1_count
			FROM user_table ut
			INNER JOIN BUSINESS_USER bu
			ON ut.USER_ID = bu.USER_ID
			INNER JOIN SIGUNGU sgg 
			ON bu.SIGUNGU_ID = sgg.SIGUNGU_ID
			INNER JOIN SIDO sd
			ON sgg.SIDO_ID = sd.SIDO_ID
			INNER JOIN GOOD_PRICE_BUSINESS gpb 
			ON ut.USER_ID = gpb.USER_ID
			INNER JOIN INDUSTRY i 
			ON gpb.INDUSTRY_ID = i.INDUSTRY_ID 
			INNER JOIN APPROVAL_MANAGEMENT am 
			ON gpb.store_id = am.store_id
			<where>
				<if test="data.sidoId != null and data.sidoId != ''">
					AND sd.SIDO_ID = #{data.sidoId}
				</if>
		           
				<if test="data.sidoName != null and data.sidoName != '' and data.sidoName != 'null'">
		           AND sd.SIDO_NAME = #{data.sidoName}
				</if>
		           
		        <if test="data.sigunguId != null and data.sigunguId != ''">
		           AND sgg.SIGUNGU_ID = #{data.sigunguId}
		        </if>
		           
		        <if test="data.sigunguName != null and data.sigunguName != '' and data.sigunguName != 'null' ">
		        	AND sgg.SIGUNGU_NAME = #{data.sigunguName}
		        </if>
		        
		        <if test="data.industryId != null and data.industryId != ''">
		        	AND i.INDUSTRY_ID = #{data.industryId}
		        </if>
		        
		        <if test="data.industryName != null and data.industryName != '' and data.industryName != 'null' ">
		        	AND i.INDUSTRY_NAME = #{data.industryName}
		        </if>
		
				<if test="data.storeName != null and data.storeName.trim() != ''">
                	AND bu.STORE_NAME LIKE '%' || #{data.storeName} || '%'
				</if>
				 
				<if test="data.mainMenu != null and data.mainMenu.trim() != ''">
				 	AND am.MAIN_MENU LIKE '%' || #{data.mainMenu} || '%'
				</if>
		      
		        <if test="data.takeout != null and data.takeout != ''">
		        	AND gpb.TAKEOUT = #{data.takeout}
		        </if>
		        
		        <if test="data.delivery != null and data.delivery != ''">
		        	AND gpb.DELIVERY = #{data.delivery}
		        </if>
		        
		        <if test="data.wifi != null and data.wifi != ''">
		        	AND gpb.WIFI = #{data.wifi}
		        </if>
		        
		        <if test="data.pet != null and data.pet != ''">
		        	AND gpb.PET = #{data.pet}
		        </if>
		        
		        <if test="data.kid != null and data.kid != ''">
		         	AND gpb.KID = #{data.kid}
		        </if>
		        
		        <if test="data.parking != null and data.parking != ''">
		        	AND gpb.PARKING = #{data.parking}
		        </if>
			</where>
		) tb	 
    </sql>
    
    <!-- 업소상세페이지 -->
    <sql id="storeDetailSql">
	  SELECT   GPB.INDUSTRY_ID, 
			   GPB.AVERAGE_RATING ,
			   r.REVIEW_ID ,
			   r.STORE_ID ,
			   r.USER_ID ,
			   r.RATING ,
			   r.CONTENT ,
			   r.REVIEW_PRICE ,
			   r.LIKE_COUNT ,
			   r.CREATED_AT ,
			   r.REVIEW_MENU ,
			   ri.REVIEW_IMG 
		FROM GOOD_PRICE_BUSINESS gpb 
		INNER JOIN REVIEW r 
		ON GPB.STORE_ID = r.STORE_ID 
		INNER JOIN REVIEW_IMG ri  
		ON r.REVIEW_ID = ri.REVIEW_ID
    </sql>
</mapper>